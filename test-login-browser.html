<!doctype html>
<html>
  <head>
    <title>Login Test - DoveApp</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      button {
        background: #0066cc;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
      }
      button:hover {
        background: #0052a3;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .error {
        color: #d32f2f;
      }
      .success {
        color: #2e7d32;
      }
      pre {
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 15px;
        border-radius: 4px;
        overflow-x: auto;
      }
      input {
        width: 100%;
        padding: 8px;
        margin: 5px 0 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <h1>üîê DoveApp Login Diagnostic Tool</h1>

    <div class="card">
      <h2>1. Configuration Check</h2>
      <p id="config-status">Checking...</p>
    </div>

    <div class="card">
      <h2>2. Test Login</h2>
      <input
        type="email"
        id="email"
        placeholder="Email"
        value="admin@demo.com"
      />
      <input
        type="password"
        id="password"
        placeholder="Password"
        value="demo123"
      />
      <button onclick="testLogin()">Test Login</button>
      <button onclick="clearResults()">Clear</button>
      <div id="login-results"></div>
    </div>

    <div class="card">
      <h2>3. Test RLS Policies</h2>
      <button onclick="testRLS()">Test RLS Query</button>
      <div id="rls-results"></div>
    </div>

    <script>
      // You need to set these from your .env.local file
      const SUPABASE_URL = prompt(
        'Enter your NEXT_PUBLIC_SUPABASE_URL:',
        'https://your-project.supabase.co'
      );
      const SUPABASE_ANON_KEY = prompt(
        'Enter your NEXT_PUBLIC_SUPABASE_ANON_KEY:',
        'your-anon-key'
      );

      if (
        !SUPABASE_URL ||
        !SUPABASE_ANON_KEY ||
        SUPABASE_URL.includes('your-project')
      ) {
        document.getElementById('config-status').innerHTML =
          '<span class="error">‚ùå Invalid configuration. Please refresh and enter valid credentials.</span>';
      } else {
        document.getElementById('config-status').innerHTML =
          '<span class="success">‚úÖ Configuration loaded</span>';
      }

      const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      async function testLogin() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const resultsDiv = document.getElementById('login-results');

        resultsDiv.innerHTML = '<p>Testing login...</p>';
        const results = {};

        try {
          // Step 1: Sign in
          console.log('Step 1: Signing in...');
          const { data: authData, error: authError } =
            await supabase.auth.signInWithPassword({
              email,
              password,
            });

          results.step1_auth = authError
            ? { error: authError.message }
            : {
                success: true,
                userId: authData.user?.id,
                email: authData.user?.email,
              };

          if (authError || !authData.user) {
            resultsDiv.innerHTML = `<pre>${JSON.stringify(results, null, 2)}</pre>`;
            return;
          }

          // Step 2: Get user profile
          console.log('Step 2: Getting user profile...');
          const { data: userProfile, error: userError } = await supabase
            .from('users')
            .select('*')
            .eq('id', authData.user.id)
            .single();

          results.step2_user_profile = userError
            ? { error: userError.message }
            : userProfile;

          // Step 3: Get memberships (THIS IS WHERE IT FAILS)
          console.log('Step 3: Getting memberships...');
          const { data: memberships, error: membershipError } = await supabase
            .from('account_memberships')
            .select('role, account_id, is_active')
            .eq('user_id', authData.user.id)
            .eq('is_active', true);

          results.step3_memberships = membershipError
            ? {
                error: membershipError.message,
                hint: membershipError.message.includes('infinite recursion')
                  ? 'You need to apply migration 039 in Supabase SQL Editor!'
                  : null,
              }
            : memberships;

          // Step 4: Determine redirect
          if (memberships && memberships.length > 0) {
            const role = memberships[0].role;
            results.step4_should_redirect_to =
              role === 'OWNER' || role === 'ADMIN'
                ? '/admin/dashboard'
                : role === 'TECH'
                  ? '/tech/today'
                  : '/portal/home';
          }
        } catch (error) {
          results.unexpected_error = error.message;
        }

        resultsDiv.innerHTML = `<pre>${JSON.stringify(results, null, 2)}</pre>`;
      }

      async function testRLS() {
        const resultsDiv = document.getElementById('rls-results');
        resultsDiv.innerHTML = '<p>Testing RLS...</p>';

        try {
          const { data, error } = await supabase
            .from('account_memberships')
            .select('*')
            .limit(5);

          if (error) {
            resultsDiv.innerHTML = `
            <p class="error">‚ùå RLS Query Failed</p>
            <pre>${JSON.stringify({ error: error.message }, null, 2)}</pre>
            ${
              error.message.includes('infinite recursion')
                ? '<p class="error"><strong>‚ö†Ô∏è You need to apply migration 039!</strong></p>'
                : ''
            }
          `;
          } else {
            resultsDiv.innerHTML = `
            <p class="success">‚úÖ RLS Query Successful</p>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          `;
          }
        } catch (error) {
          resultsDiv.innerHTML = `<p class="error">Error: ${error.message}</p>`;
        }
      }

      function clearResults() {
        document.getElementById('login-results').innerHTML = '';
        document.getElementById('rls-results').innerHTML = '';
      }
    </script>
  </body>
</html>
